# Prerequisites
* Completed [setup](../setup/README.md)
* A new cluster generated by `kind create cluster`

Setup storage using the default local provider

```bash
# Create a pod to create empty files for testing
kubectl apply -f data-gen-pod.yml
# Wait for the pod to come online
kubectl get pods test-app

# Retrieve the persistent volume name
pv_name=$(kubectl get pvc example-claim -o jsonpath='{.spec.volumeName}')
# Get the path to the data on the host
host_data_path=$(kubectl get pv $pv_name -o jsonpath='{.spec.hostPath.path}')

# Compare the two directories to see they are the same
docker exec kind-control-plane ls "$host_data_path"
kubectl exec test-app ls /data

# Remove the pod in preparation for the next part
kubectl delete -f data-gen-pod.yml
```

Switch the volume over to use NFS

```bash
# Make sure the kind node willl support nfs
docker exec -it kind-control-plane bash -c "apt-get update -y && apt-get install nfs-kernel-server -y"

# Create the backing storage for NFS
kubectl apply -f nfs-storage.yml

# Setup an example NFS
kubectl apply -f https://raw.githubusercontent.com/kubernetes-incubator/external-storage/v5.5.0/nfs/deploy/kubernetes/rbac.yaml
kubectl apply -f https://raw.githubusercontent.com/kubernetes-incubator/external-storage/v5.5.0/nfs/deploy/kubernetes/deployment.yaml
# Patch the NFS to use default volume provider instead of host
kubectl patch Deployment nfs-provisioner --type='json' -p="$(cat patch.json)"

# Create the storage class to talk with NFS
kubectl apply -f nfs-storage-class.yml

# Wait for the NFS to be up and running
kubectl get pods

# Modify the data-gen-pod.yml to use the nfs storage class
# ...
# metadata:
#   name: example-claim
#   annotations:
#     volume.beta.kubernetes.io/storage-class: "example-nfs"
# spec:
# ...
kubectl apply -f data-gen-pod.yml

# Retrieve a reference to the nfs pod name and the name of the pvc binding it
nfs_pod=$(kubectl get pods -o jsonpath='{.items[0].metadata.name}' -l=app=nfs-provisioner)
pvc_name=$(kubectl get pvc example-claim -o jsonpath='{.spec.volumeName}')

# Checkout the files on the nfs server
kubectl exec -it $nfs_pod -- ls /export/$pvc_name
```
