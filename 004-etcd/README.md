# Prerequisites
* Completed [setup](../setup/README.md)
* A new cluster generated by `kind create cluster`
* Basic understanding of `Prometheus`

For messing around with the etcd within the cluster:
```bash
# List all the etcd pods currently running in the cluster (for kind there will be one)
kubectl get pods -n kube-system -l component=etcd
# Do a full perf check (very slow)
kubectl exec -it -n kube-system etcd-kind-control-plane -- sh -c "export ETCDCTL_API=3 ; etcdctl \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
    --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \
    perf check"
# Get a list of all the keys in etcd that are used by Kube
kubectl exec -it -n kube-system etcd-kind-control-plane -- sh -c "export ETCDCTL_API=3 ; etcdctl \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
    --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \
    get --prefix /"
# Watch all events in etcd to get an idea of what's going on
kubectl exec -it -n kube-system etcd-kind-control-plane -- sh -c "export ETCDCTL_API=3 ; etcdctl \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
    --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \
    watch --prefix / -w fields"
```

Setup Prometheus to pull data from etcd
```bash
kubectl apply -f prometheus.yml
# Forward the Prometheus port to localhost
kubectl port-forward -n kube-system service/prometheus-service 9090:9090
# Go to localhost:9090 in the browser to view data
# Possible queries to try in Prometheus:
#   rate(etcd_debugging_mvcc_events_total[1m])
#   rate(etcd_server_slow_apply_total[1m])
#   etcd_debugging_mvcc_keys_total
```

Exercises:
* Try adding/removing lots of Kubernetes items to the cluster.  How does etcd react in Prometheus?  How does the etcd health check react?
* [etcdeath](https://github.com/jdumars/etcdeath/) - Can you take down the etcd inside your cluster?
